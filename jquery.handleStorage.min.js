/**
 *
 * jQuery plugin to impliment local storage with optional AES
 * encryption support via the Gibberish-AES libraries
 *
 * Fork me @ https://www.github.com/jas-/jQuery.handleStorage
 *
 * FEATURES:
 * - HTML5 localStorage support
 * - HTML5 sessionStorage support
 * - Cookie support
 * - AES encryption support
 *
 * REQUIREMENTS:
 * - jQuery libraries (required - http://www.jquery.com)
 * - jQuery cookie plugin (optional - http://plugins.jquery.com/files/jquery.cookie.js.txt)
 * - Gibberish-AES libraries (optional - https://github.com/mdp/gibberish-aes)
 *
 * OPTIONS:
 * - appID:   Unique identifier used as storage object key
 * - storage: HTML5 localStorage, sessionStorage and cookies supported
 * - aes:     Use AES encryption for local storage
 * - uuid:    Random RFC-4122 string used as AES password
 *
 * Author: Jason Gerfen
 * Email: jason.gerfen@gmail.com
 * Copyright: Jason Gerfen
 *
 * License: GPL
 *
 */

(function($){$.fn.handleStorage=function(method){var defaults={appID:"jQuery.handleStorage",storage:"localStorage",aes:false,uuid:"",form:"",data:{}};var methods={init:function(o){var opts=$.extend({},defaults,o);opts.form=$(this).attr("id");if(vO(opts)){opts.data[opts.appID]=(_e(opts))?_e(opts):{};var orig=gStore(opts);if((typeof orig==="object")&&(sChk(orig)>0)){sF(opts,orig)}$("#"+opts.form).delegate("input, input:radio:selected, input:checkbox:checked, textarea","change keyup blur submit",function(){svF(opts)});return true}else{return false}}};var sChk=function(obj){var n=0;$.each(obj,function(k,v){if(obj.hasOwnProperty(k)){n++}});return n};var sI=function(type,k,v){var x=false;type=(vStore(type))?type:"cookie";switch(type){case"localStorage":x=sL(k,v);break;case"sessionStorage":x=sS(k,v);break;case"cookie":x=sC(k,v);break;default:x=sL(k,v);break}return x};var gI=function(type,k){var x=false;type=(vStore(type))?type:"cookie";switch(type){case"localStorage":x=gL(k);break;case"sessionStorage":x=gS(k);break;case"cookie":x=gC(k);break;default:x=gL(k);break}return x};var sL=function(k,v){return(localStorage.setItem(k,v))?false:true};var sS=function(k,v){return(sessionStorage.setItem(k,v))?false:true};var sC=function(k,v){if(typeof $.cookie==="function"){return($.cookie(k,v,{expires:7}))?true:false}else{return false}};var gL=function(k){return(localStorage.getItem(k))?localStorage.getItem(k):false};var gS=function(k){return(sessionStorage.getItem(k))?sessionStorage.getItem(k):false};var gC=function(name){if(typeof $.cookie==="function"){return($.cookie(name))?$.cookie(name):false}else{return false}};var _e=function(o){return(gI(o.storage,o.appID))?JSON.parse(gI(o.storage,o.appID)):false};var gStore=function(o){var ret={},x;if(typeof o.data[o.appID][o.form]==="object"){$.each($("#"+o.form+" > :input"),function(k,v){if((vStr(v.name)!==false)&&(vStr(o.data[o.appID][o.form][v.name])!==false)){ret[v.name]=((o.aes)&&(o.data[o.appID][o.form]["uuid"])&&(x!==false))?GibberishAES.dec(o.data[o.appID][o.form][v.name],o.data[o.appID][o.form]["uuid"]):o.data[o.appID][o.form][v.name]}})}return ret};var sF=function(o,arg){if(sChk(arg)>0){$.each(arg,function(a,b){if(($("#"+o.form+" > input[name="+a+"]").attr("name")===a)||($("#"+o.form+" > textarea[name="+a+"]").attr("name")===a)&&(vStr(b)!==false)){$("#"+o.form+" > input[name="+a+"], #"+o.form+" > textarea[name="+a+"]").val(b)}})}};var svF=function(o){var x={};x[o.form]={};$.each($("#"+o.form+" > :input"),function(k,v){if((vStr(v.value)!==false)&&(vStr(v.name)!==false)){if((o.aes)&&(!o.uuid)){o.uuid=hK(o);x[o.form]["uuid"]=o.uuid}x[o.form][v.name]=((o.aes)&&(x[o.form]["uuid"]))?GibberishAES.enc(v.value,x[o.form]["uuid"]):v.value}});o.data[o.appID]=(sChk(o.data[o.appID])>0)?$.extend({},o.data[o.appID],x):x;sI(o.storage,o.appID,JSON.stringify(o.data[o.appID]))};var vStr=function(string){if(string){return((string===false)||(string.length===0)||(!string)||(string===null)||(string==="")||(typeof string==="undefined"))?false:true}else{return false}};var vStore=function(type){try{return((type in window)&&(window[type]))?true:false}catch(e){return false}};var vO=function(opts){var ret=true;if(opts.aes){if(!$.isFunction(GibberishAES.enc)){console.log("AES use specified but required libraries not available.Please include the Gibberish-AES libs...");ret=false}}if(opts.storage==="cookie"){if(!$.isFunction($.cookie)){console.log("Cookie use specified but required libraries not available.Please include the jQuery cookie plugin...");ret=false}}return ret};var gUUID=function(len){var chars="0123456789abcdef".split("");var uuid=[],rnd=Math.random,r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-";uuid[14]="4";for(var i=0;i<36;i++){if(!uuid[i]){r=0|rnd()*16;uuid[i]=chars[(i==19)?(r&3)|8:r&15]}}return(len!==null)?uuid.join("").replace(/-/g,"").split("",len).join(""):uuid.join("")};var hK=function(o){if(o.aes){var x=(_e(o))?_e(o):{};x[o.form]=(x[o.form])?x[o.form]:{};var y=(vStr(x[o.form]["uuid"]))?x[o.form]["uuid"]:gUUID(null);return y}};var __r=function(obj){$.each(obj,function(x,y){if(typeof y==="object"){__r(y)}else{console.log(x+" => "+y)}})};if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if((typeof method==="object")||(!method)){return methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on "+opts.name)}}}})(jQuery);
