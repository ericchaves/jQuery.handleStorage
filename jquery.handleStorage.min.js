/**
 *
 * jQuery plugin to impliment local storage with optional AES
 * encryption support via the Gibberish-AES libraries
 *
 * Fork me @ https://www.github.com/jas-/jQuery.handleStorage
 *
 * FEATURES:
 * - HTML5 localStorage support
 * - HTML5 sessionStorage support
 * - Cookie support
 * - AES encryption support
 *
 * REQUIREMENTS:
 * - jQuery libraries (required - http://www.jquery.com)
 * - jQuery cookie plugin (optional - http://plugins.jquery.com/files/jquery.cookie.js.txt)
 * - Gibberish-AES libraries (optional - https://github.com/mdp/gibberish-aes)
 *
 * OPTIONS:
 * - appID:   Unique identifier used as storage object key
 * - storage: HTML5 localStorage, sessionStorage and cookies supported
 * - aes:     Use AES encryption for local storage
 * - uuid:    Random RFC-4122 string used as AES password
 *
 * Author: Jason Gerfen
 * Email: jason.gerfen@gmail.com
 * Copyright: Jason Gerfen
 *
 * License: GPL
 *
 */

(function(a){a.fn.handleStorage=function(d){var k={appID:"jQuery.handleStorage",storage:"localStorage",aes:false,uuid:"",form:a(this).attr("id"),data:{}};var w={init:function(y){var x=a.extend({},k,y);if(m(x)){v(x);x.data[x.appID]=(e(x))?e(x):{};var z=c(x);if((typeof z==="object")&&(h(z)>0)){t(x,z)}a("#"+x.form).live("submit",function(A){f(x)});return true}else{return false}}};var h=function(x){var y=0;a.each(x,function(A,z){if(x.hasOwnProperty(A)){y++}});return y};var q=function(B,A,z){var y=false;B=(b(B))?B:"cookie";switch(B){case"localStorage":y=o(A,z);break;case"sessionStorage":y=i(A,z);break;case"cookie":y=u(A,z);break;default:y=o(A,z);break}return y};var n=function(A,z){var y=false;A=(b(A))?A:"cookie";switch(A){case"localStorage":y=j(z);break;case"sessionStorage":y=g(z);break;case"cookie":y=s(z);break;default:y=j(z);break}return y};var o=function(y,x){return(localStorage.setItem(y,x))?false:true};var i=function(y,x){return(sessionStorage.setItem(y,x))?false:true};var u=function(y,x){if(typeof a.cookie==="function"){return(a.cookie(y,x,{expires:7}))?true:false}else{return false}};var j=function(x){return(localStorage.getItem(x))?localStorage.getItem(x):false};var g=function(x){return(sessionStorage.getItem(x))?sessionStorage.getItem(x):false};var s=function(x){if(typeof a.cookie==="function"){return(a.cookie(x))?a.cookie(x):false}else{return false}};var e=function(x){return(n(x.storage,x.appID))?JSON.parse(n(x.storage,x.appID)):false};var c=function(A){var z={},y;if(p(A.data[A.appID][A.form])){a.each(a("#"+A.form+' > :text, :password, :file, input:hidden, input:checkbox:checked, input:radio:checked, textarea, input[type="email"], input[type="url"], input[type="number"], input[type="range"], input[type="date"], input[type="month"], input[type="week"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="search"], input[type="color"]'),function(B,x){if((p(x.name)!==false)&&(p(A.data[A.appID][A.form][x.name])!==false)){z[x.name]=((A.aes)&&(A.key)&&(y!==false))?GibberishAES.dec(A.data[A.appID][A.form][x.name],A.uuid):A.data[A.appID][A.form][x.name]}})}return z};var t=function(y,x){a.each(x,function(A,z){if((a("#"+y.form+" > input[name="+A+"]").attr("name")===A)||(a("#"+y.form+" > textarea[name="+A+"]").attr("name")===A)&&(p(z)!==false)){a("#"+y.form+" > input[name="+A+"], #"+y.form+" > textarea[name="+A+"]").val(z)}})};var f=function(z){var y={};y[z.form]={};a.each(a("#"+z.form+' > :text, :password, :file, input:hidden, input:checkbox:checked, input:radio:checked, textarea, input[type="email"], input[type="url"], input[type="number"], input[type="range"], input[type="date"], input[type="month"], input[type="week"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="search"], input[type="color"]'),function(A,x){if((p(x.value)!==false)&&(p(x.name)!==false)){y[z.form][x.name]=((z.aes)&&(z.key))?GibberishAES.enc(x.value,z.uuid):x.value}});z.data[z.appID]=(h(z.data[z.appID])>0)?a.extend({},z.data[z.appID],y):y;q(z.storage,z.appID,JSON.stringify(z.data[z.appID]))};var p=function(x){if(x){return((x===false)||(x.length===0)||(!x)||(x===null)||(x==="")||(typeof x==="undefined"))?false:true}else{return false}};var b=function(x){try{return((x in window)&&(window[x]))?true:false}catch(y){return false}};var m=function(y){var x=true;if(y.aes){if(!a.isFunction(GibberishAES.enc)){console.log("AES use specified but required libraries not available.Please include the Gibberish-AES libs...");x=false}}if(y.storage==="cookie"){if(!a.isFunction(a.cookie)){console.log("Cookie use specified but required libraries not available.Please include the jQuery cookie plugin...");x=false}}return x};var r=function(x){var C="0123456789abcdef".split("");var A=[],z=Math.random,B;A[8]=A[13]=A[18]=A[23]="-";A[14]="4";for(var y=0;y<36;y++){if(!A[y]){B=0|z()*16;A[y]=C[(y==19)?(B&3)|8:B&15]}}return(x!==null)?A.join("").replace(/-/g,"").split("",x).join(""):A.join("")};var v=function(x){if(x.aes){x.key=(n(x.storage,"uuid"))?n(x.storage,"uuid"):r(null);q(x.storage,"uuid",x.key)}};var l=function(x){a.each(x,function(z,A){if(typeof A==="object"){l(A)}else{console.log(z+" => "+A)}})};if(w[d]){return w[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if((typeof d==="object")||(!d)){return w.init.apply(this,arguments)}else{a.error("Method "+d+" does not exist on "+opts.name)}}}})(jQuery);
